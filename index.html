<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>全能記帳網站</title>
    <!-- 引入 Font Awesome 圖示庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        /* 背景和全局樣式 */
        body {
            margin: 0;
            font-family: '微軟正黑體', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            animation: backgroundAnimation 15s ease infinite;
            background-size: 400% 400%;
        }
        @keyframes backgroundAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* 登出按鈕 */
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #ff758c, #ff7eb3);
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            color: #fff;
            cursor: pointer;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            z-index: 1000;
        }
        .logout-btn:hover {
            box-shadow: 0 15px 25px rgba(255, 117, 140, 0.4);
            transform: translateY(-5px);
        }
        /* 標題 */
        h1 {
            color: #fff;
            margin-top: 80px;
            text-align: center;
            font-size: 36px;
            animation: fadeInDown 1s ease forwards;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* 統計區域 */
        .summary {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeInUp 1s ease forwards;
            backdrop-filter: blur(10px);
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .summary div {
            text-align: center;
        }
        .summary h3 {
            margin-bottom: 5px;
            color: #555;
        }
        .summary p {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        /* 容器 */
        .container {
            width: 90%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeInUp 1s ease forwards;
            backdrop-filter: blur(10px);
        }
        /* 表單樣式 */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 16px;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            color: #333;
        }
        input:focus,
        select:focus,
        textarea:focus {
            border-color: #6c63ff;
            box-shadow: 0 0 8px rgba(108, 99, 255, 0.5);
        }
        /* 按鈕樣式 */
        .btn {
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 30px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            margin-top: 10px;
        }
        .btn:hover {
            box-shadow: 0 15px 25px rgba(118, 75, 162, 0.4);
            transform: translateY(-5px);
        }
        /* 交易列表 */
        .transactions {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .transaction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: transform 0.3s ease;
            animation: fadeInUp 0.5s ease forwards;
            backdrop-filter: blur(5px);
        }
        .transaction:nth-child(even) {
            background: rgba(245, 245, 245, 0.9);
        }
        .transaction:hover {
            transform: translateX(10px);
        }
        .transaction .details {
            flex: 1;
        }
        .transaction .amount {
            font-weight: bold;
            margin-right: 15px;
            font-size: 18px;
        }
        .transaction .delete-btn {
            background-color: #ff4d4d;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.3s ease;
        }
        .transaction .delete-btn:hover {
            background-color: #e60000;
            transform: scale(1.05);
        }
        /* 隱藏元素 */
        .hidden {
            display: none;
        }
        /* 搜尋區域 */
        .search-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            margin-top: 20px;
            align-items: flex-end;
        }
        .search-container .form-group {
            flex: 1 1 calc(33.333% - 20px);
            margin-right: 20px;
            margin-bottom: 20px;
        }
        .search-container .form-group:nth-child(3n) {
            margin-right: 0;
        }
        .search-container .btn {
            width: 100%;
            flex: 1 1 100%;
            margin-top: 10px;
        }
        /* 導入導出按鈕 */
        .import-export {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .import-export .btn {
            flex: 1;
            margin-right: 10px;
        }
        .import-export .btn:last-child {
            margin-right: 0;
        }
        /* 文件輸入框隱藏 */
        #importFile {
            display: none;
        }
        /* 新增過渡動畫 */
        .fade-in-up {
            animation: fadeInUp 0.5s ease forwards;
        }
        /* 響應式調整 */
        @media (max-width: 768px) {
            .search-container .form-group {
                flex: 1 1 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <button class="logout-btn" id="logoutBtn">登出</button>
    <h1 id="welcomeMessage">全能記帳網站</h1>
    <!-- 統計區域 -->
    <div class="summary">
        <div>
            <h3>總收入</h3>
            <p id="totalIncome">$0</p>
        </div>
        <div>
            <h3>總支出</h3>
            <p id="totalExpense">$0</p>
        </div>
        <div>
            <h3>結餘</h3>
            <p id="balance">$0</p>
        </div>
    </div>
    <!-- 表單容器 -->
    <div class="container">
        <!-- 收入/支出 -->
        <div class="form-group">
            <label for="type">類型</label>
            <select id="type">
                <option value="income">收入</option>
                <option value="expense">支出</option>
            </select>
        </div>
        <!-- 日期 -->
        <div class="form-group">
            <label for="date">日期</label>
            <input type="date" id="date">
        </div>
        <!-- 類別 -->
        <div class="form-group">
            <label for="category">分類</label>
            <select id="category">
                <!-- 動態生成類別選項 -->
            </select>
            <!-- 其他類別輸入框 -->
            <input type="text" id="otherCategory" class="hidden" placeholder="請輸入其他分類">
        </div>
        <!-- 金額 -->
        <div class="form-group">
            <label for="amount">金額</label>
            <input type="number" id="amount" placeholder="請輸入金額">
        </div>
        <!-- 備註 -->
        <div class="form-group">
            <label>
                <input type="checkbox" id="addNoteCheckbox"> 添加備註
            </label>
            <textarea id="note" class="hidden" placeholder="請輸入備註"></textarea>
        </div>
        <!-- 按鈕 -->
        <button id="add-btn" class="btn">新增記帳</button>
    </div>
    <!-- 搜尋區域 -->
    <div class="container">
        <h2>搜尋與過濾</h2>
        <div class="search-container">
            <div class="form-group">
                <label for="searchType">類型</label>
                <select id="searchType">
                    <option value="">全部</option>
                    <option value="income">收入</option>
                    <option value="expense">支出</option>
                </select>
            </div>
            <div class="form-group">
                <label for="searchCategory">分類</label>
                <select id="searchCategory">
                    <!-- 動態生成類別選項 -->
                </select>
            </div>
            <div class="form-group">
                <label for="searchStartDate">開始日期</label>
                <input type="date" id="searchStartDate">
            </div>
            <div class="form-group">
                <label for="searchEndDate">結束日期</label>
                <input type="date" id="searchEndDate">
            </div>
            <div class="form-group">
                <label for="searchKeyword">關鍵字</label>
                <input type="text" id="searchKeyword" placeholder="備註關鍵字">
            </div>
            <div class="form-group" style="flex: 1 1 100%; margin-top: 10px;">
                <button id="search-btn" class="btn">搜尋</button>
            </div>
        </div>
    </div>
    <!-- 交易列表 -->
    <div class="container">
        <h2>交易記錄</h2>
        <div class="transactions"></div>
    </div>
    <!-- 導入導出按鈕 -->
    <div class="container import-export">
        <button id="export-btn" class="btn">導出資料</button>
        <button id="import-btn" class="btn">導入資料</button>
        <input type="file" id="importFile">
    </div>
    <!-- 引入 Font Awesome 圖示庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <!-- JavaScript 代碼 -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 檢查使用者是否已登入
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('請先登入！');
                window.location.href = 'login.html';
                return; // 防止後續代碼執行
            }

            document.getElementById('welcomeMessage').textContent = `歡迎，${currentUser.username}`;

            // 初始化
            const transactionsDiv = document.querySelector('.transactions');
            const typeSelect = document.getElementById('type');
            const dateInput = document.getElementById('date');
            const categorySelect = document.getElementById('category');
            const otherCategoryInput = document.getElementById('otherCategory');
            const amountInput = document.getElementById('amount');
            const addNoteCheckbox = document.getElementById('addNoteCheckbox');
            const noteTextarea = document.getElementById('note');
            const addButton = document.getElementById('add-btn');
            const totalIncomeElem = document.getElementById('totalIncome');
            const totalExpenseElem = document.getElementById('totalExpense');
            const balanceElem = document.getElementById('balance');
            const logoutBtn = document.getElementById('logoutBtn');

            // 搜尋相關
            const searchType = document.getElementById('searchType');
            const searchCategory = document.getElementById('searchCategory');
            const searchStartDate = document.getElementById('searchStartDate');
            const searchEndDate = document.getElementById('searchEndDate');
            const searchKeyword = document.getElementById('searchKeyword');
            const searchBtn = document.getElementById('search-btn');

            // 導入導出相關
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('importFile');

            let expenseChart;

            // 類別管理
            let defaultCategories = ['薪水', '飲食', '交通', '娛樂', '購物', '醫療', '教育', '房租', '水電', '投資', '旅遊', '保險', '禮物', '其他'];
            let userCategories = JSON.parse(localStorage.getItem('userCategories_' + currentUser.email)) || defaultCategories;

            // 讀取使用者的交易資料
            let transactionsData = JSON.parse(localStorage.getItem('transactionsData')) || {};
            let transactions = transactionsData[currentUser.email] || [];

            // 初始化類別選項
            function initCategoryOptions() {
                categorySelect.innerHTML = '';
                searchCategory.innerHTML = '<option value="">全部</option>';
                userCategories.forEach(category => {
                    const option1 = document.createElement('option');
                    option1.value = category;
                    option1.textContent = category;
                    categorySelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = category;
                    option2.textContent = category;
                    searchCategory.appendChild(option2);
                });
                // 在類別選項中添加“管理分類”選項
                const manageOption = document.createElement('option');
                manageOption.value = 'manage';
                manageOption.textContent = '管理分類';
                categorySelect.appendChild(manageOption);
            }

            initCategoryOptions();

            // 顯示所有記帳資料
            function displayTransactions(filter = false) {
                transactionsDiv.innerHTML = ''; // 清空現有的交易

                let data = transactions;

                if (filter) {
                    const type = searchType.value;
                    const category = searchCategory.value;
                    const startDate = searchStartDate.value;
                    const endDate = searchEndDate.value;
                    const keyword = searchKeyword.value.trim().toLowerCase();

                    data = data.filter(t => {
                        let match = true;
                        if (type && t.type !== type) match = false;
                        if (category && t.category !== category) match = false;
                        if (startDate && t.date < startDate) match = false;
                        if (endDate && t.date > endDate) match = false;
                        if (keyword && (!t.note || !t.note.toLowerCase().includes(keyword))) match = false;
                        return match;
                    });
                }

                data.forEach((transaction, index) => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.classList.add('transaction', 'fade-in-up');
                    transactionDiv.innerHTML = `
                        <div class="details">
                            <p><strong>${transaction.category}</strong> - ${transaction.date}</p>
                            ${transaction.note ? `<p>備註：${transaction.note}</p>` : ''}
                        </div>
                        <span class="amount" style="color: ${transaction.type === 'income' ? '#2ecc71' : '#e74c3c'};">
                            ${transaction.type === 'income' ? '+' : '-'}$${transaction.amount}
                        </span>
                        <button class="delete-btn" onclick="deleteTransaction(${transactions.indexOf(transaction)})">刪除</button>
                    `;
                    transactionsDiv.appendChild(transactionDiv);
                });
                updateSummary();
            }

            // 新增交易
            function addTransaction() {
                const type = typeSelect.value;
                const date = dateInput.value || new Date().toISOString().split('T')[0];
                const category = categorySelect.value === '其他' ? otherCategoryInput.value.trim() : categorySelect.value;
                const amount = parseFloat(amountInput.value.trim());
                const note = addNoteCheckbox.checked ? noteTextarea.value.trim() : '';

                if (categorySelect.value === 'manage') {
                    manageCategories();
                    return;
                }

                if (category && amount) {
                    const newTransaction = { type, date, category, amount, note };
                    transactions.push(newTransaction);
                    saveTransactions();
                    displayTransactions();
                    // 清空表單
                    amountInput.value = '';
                    noteTextarea.value = '';
                    otherCategoryInput.value = '';
                    otherCategoryInput.classList.add('hidden');
                    noteTextarea.classList.add('hidden');
                    addNoteCheckbox.checked = false;
                }
            }

            // 刪除交易
            function deleteTransaction(index) {
                transactions.splice(index, 1);
                saveTransactions();
                displayTransactions();
            }

            // 保存交易資料
            function saveTransactions() {
                transactionsData[currentUser.email] = transactions;
                localStorage.setItem('transactionsData', JSON.stringify(transactionsData));
            }

            // 更新統計數據
            function updateSummary() {
                const totalIncome = transactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                const totalExpense = transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                const balance = totalIncome - totalExpense;

                totalIncomeElem.textContent = `$${totalIncome}`;
                totalExpenseElem.textContent = `$${totalExpense}`;
                balanceElem.textContent = `$${balance}`;
            }

            // 切換其他類型選項顯示
            categorySelect.addEventListener('change', () => {
                if (categorySelect.value === '其他') {
                    otherCategoryInput.classList.remove('hidden');
                } else {
                    otherCategoryInput.classList.add('hidden');
                }
            });

            // 備註選項切換
            addNoteCheckbox.addEventListener('change', () => {
                if (addNoteCheckbox.checked) {
                    noteTextarea.classList.remove('hidden');
                } else {
                    noteTextarea.classList.add('hidden');
                }
            });

            // 登出功能
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            });

            // 綁定按鈕點擊事件
            addButton.addEventListener('click', addTransaction);

            // 搜尋按鈕事件
            searchBtn.addEventListener('click', () => {
                displayTransactions(true);
            });

            // 導出資料
            exportBtn.addEventListener('click', () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", currentUser.email + "_transactions.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            });

            // 導入資料
            importBtn.addEventListener('click', () => {
                importFile.click();
            });

            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            transactions = importedData;
                            saveTransactions();
                            displayTransactions();
                            alert('資料導入成功！');
                        } else {
                            alert('資料格式不正確！');
                        }
                    } catch (error) {
                        alert('資料格式不正確！');
                    }
                };
                reader.readAsText(file);
            });

            // 類別管理
            function manageCategories() {
                const newCategories = prompt('請輸入新的分類（用逗號分隔）：', userCategories.join(','));
                if (newCategories !== null) {
                    userCategories = newCategories.split(',').map(cat => cat.trim()).filter(cat => cat);
                    localStorage.setItem('userCategories_' + currentUser.email, JSON.stringify(userCategories));
                    initCategoryOptions();
                }
            }

            // 初始顯示
            displayTransactions();
        });
    </script>
</body>
</html>
